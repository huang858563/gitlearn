CREATE DEFINER=`root`@`%` PROCEDURE `new_editlog_sp`()
BEGIN
	DECLARE
		v_table_name VARCHAR ( 255 );
		
		declare v_level1 varchar(100);
		declare v_level2 varchar(100);
		declare v_level3 varchar(100);
		declare v_level4 varchar(100);
		declare v_folder_id varchar(100);
		declare kpi_model_id varchar(100);
		declare kpi_model_id_new varchar(100);
		declare xml_contnet LONGTEXT DEFAULT('');
		declare xml_col_str LONGTEXT;
	DECLARE
		done INT DEFAULT 0;
	DECLARE
		v_tab_count INT DEFAULT 0;
	DECLARE
		cur_table_name CURSOR FOR SELECT
		table_name 
	FROM
		information_schema.`TABLES` 
	WHERE
		table_schema = 'dp_ads' 
		AND ( table_name LIKE   '%ppm_ads_%' or table_name like '%dpm_ads_personel%' or table_name like '%dpm_ads_production%' or table_name like '%dpm_ads_quality%' or table_name like '%dpm_ads_safety%'  );
	DECLARE
		CONTINUE HANDLER FOR NOT found 
		SET done = 1;
	OPEN cur_table_name;
	looplab :
	LOOP
			FETCH cur_table_name INTO v_table_name;
		IF
			done = 1 THEN
				LEAVE looplab;
			
		END IF;
		set kpi_model_id=NULL;
		set v_folder_id=NULL;
		select SPLIT_STR(v_table_name,'_',1),SPLIT_STR(v_table_name,'_',2),SPLIT_STR(v_table_name,'_',3),SPLIT_STR(v_table_name,'_',4) into v_level1,v_level2,v_level3,v_level4;
		
	  select a.id into v_folder_id from sys_data_group a where a.item_name=v_level3 and a.group_type='kpimodel';
		
		show variables like 'group_concat_max_len';
		
		if ISNULL(v_folder_id) then
		set v_level1='1';
		else
				select id into kpi_model_id from sys_kpi_model where name=v_table_name and folder_id=v_folder_id;
				 if ISNULL(kpi_model_id) then
				 set v_level1='2';
			    else				
					
					set xml_contnet=concat('<?xml version=\'1.0\' encoding=\'UTF-8\'?><database xmlns=\'http://db.apache.org/ddlutils/schema/1.1\' name=\'dp_ads\'><table name=\'',v_table_name,'\' description=\'vendor mapping\' sourceName=\'',v_table_name,'\'>');
					
					
			select GROUP_CONCAT(concat('<column name=\'',a.COLUMN_NAME,'\' type=\'',case upper(a.DATA_TYPE) when 'INT' then 'INTEGER' when 'LONG' then 'BIGINT' else upper(a.DATA_TYPE) end,'\' size=\'',  case a.CHARACTER_MAXIMUM_LENGTH is null when true then 'null' else CAST(a.CHARACTER_MAXIMUM_LENGTH as char) end,'\' primaryKey=\'',(case  a.COLUMN_KEY when 'PRI' then 'true' else 'false' end)	,'\' required=\'',case a.IS_NULLABLE when 'YES' then 'false' else 'true' end ,'\' autoIncrement=\'', case a.EXTRA when 'auto_increment' then 'true' else 'false' end,'\' default=\'',case a.COLUMN_DEFAULT is null when true then '' else a.COLUMN_DEFAULT end,'\' description=\'',a.column_comment,'\' sourceName=\'',a.COLUMN_NAME,'\' />') Separator '' ) into xml_col_str from  information_schema.`COLUMNS` a where a.table_schema='dp_ads' and a.table_name=v_table_name GROUP BY a.table_name;
				
					set xml_contnet=concat(xml_contnet,xml_col_str,'</table></database>');

		insert into sys_kpimodel_editlog values(uuid(),kpi_model_id,xml_contnet,xml_contnet,0,1,'gwh',now(),'');

					end if;
		end if;
		set v_tab_count=v_tab_count+1;
	END LOOP;

	CLOSE cur_table_name;
select v_tab_count;
END